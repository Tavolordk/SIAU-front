# Resolver DNS de Docker
resolver 127.0.0.11 valid=5s ipv6=off;

upstream usuarios_upstream      { server usuarios:8080;     keepalive 32; }
upstream solicitudes_upstream   { server solicitudes:8080;  keepalive 16; }
upstream catalogos_upstream     { server catalogos:8080;    keepalive 16; }
upstream captcha_upstream       { server captcha:8080;      keepalive 8;  }

server {
  listen 80;
  server_name _;

  # Angular SPA estática
  root  /usr/share/nginx/html;
  index index.html;

  # Cabeceras y timeouts comunes de proxy
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_redirect off;
  proxy_connect_timeout 60s;
  proxy_read_timeout    60s;
  proxy_send_timeout    60s;

  # ===== USUARIOS =====
  location = /api/user/login {
    proxy_pass http://usuarios_upstream/user/login;
  }
  location ^~ /api/user/ {
    rewrite ^/api/user/(.*)$ /user/$1 break;
    proxy_pass http://usuarios_upstream;
  }

  # ===== SOLICITUDES =====
  location ^~ /api/solicitudes/ {
    proxy_pass http://solicitudes_upstream/;
  }
  location ~ ^/api/solicitudes/api/solicitudes/(.*)$ {
    rewrite ^/api/solicitudes/api/solicitudes/(.*)$ /$1 break;
    proxy_pass http://solicitudes_upstream;
  }

  # ===== CATÁLOGOS =====
  # Mantener /catalogos en el path hacia el backend
  location ^~ /api/catalogos/ {
    proxy_pass http://catalogos_upstream/catalogos/;
  }

  # ===== CAPTCHA =====
  location = /api/captcha      { proxy_pass http://captcha_upstream/api/captcha; }
  location ^~ /api/captcha/    { proxy_pass http://captcha_upstream/api/captcha/; }

  # ===== SPA fallback =====
  location / {
    try_files $uri $uri/ /index.html;
  }
}
