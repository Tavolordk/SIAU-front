<ng-container *ngIf="loading">
  <div class="loaderlogin-overlay">
    <div class="loaderlogin-spinner"></div>
    <p>Cargando…</p>
  </div>
</ng-container>

<ng-container *ngIf="!loading">
  <!-- main-overlay si lo usas detrás de header -->
  <div class="main-overlay" style="top:80px !important"></div>

  <!-- Vista previa de los datos importados -->
  <div class="solicitudes_masiva-container">
    <div class="solicitudes_masiva-tabla-contenedor">
      <!-- Filtro / acciones de tabla -->
      <div class="solicitudes_masiva-toolbar">
        <label class="chk">
          <input type="checkbox" [(ngModel)]="mostrarSoloIncorrectos" />
          Mostrar solo incorrectos
        </label>

        <span class="stats">
          {{ enviadosCount }} enviados · {{ pendientesCount }} pendientes
        </span>

        <div class="spacer"></div>

        <button type="button" class="btn-chico" (click)="selectValidos()">
          Seleccionar válidos
        </button>
        <button type="button" class="btn-chico" (click)="limpiarSeleccion()">
          Limpiar selección
        </button>
      </div>

      <table class="solicitudes_masiva-tabla">
        <thead>
          <tr>
            <th style="width:5%;" class="fw-bold">No.</th>
            <th style="width:40%;" class="fw-bold">Nombre</th>
            <th style="width:10%; text-align:center;" class="fw-bold">Status</th>
            <th style="width:35%; text-align:center;" class="fw-bold">Descripcion</th>
            <th style="width:10%; text-align:center;" class="fw-bold">Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="!(rowsVisibles?.length)">
            <td colspan="5">No hay datos cargados.</td>
          </tr>

          <tr
            *ngFor="let cedula of (rowsVisibles | slice:((currentPage-1)*itemsPerPage):(currentPage*itemsPerPage)); let i = index"
            [class.row-sending]="cedula.__sending" [class.row-ok]="cedula.__okSent"
            [class.row-fade-out]="cedula.__fadeOut">

            <!-- # -->
            <td>{{ (currentPage-1)*itemsPerPage + i + 1 }}</td>

            <!-- Nombre + checkbox selección -->
            <td>
              <input type="checkbox" [(ngModel)]="cedula.descargar"
                [disabled]="cedula.__sending || !isListoParaDescargar(cedula, getOriginalIndex(i))" [title]="!isListoParaDescargar(cedula, getOriginalIndex(i))
          ? 'Corrige los errores o edítalo para poder descargarlo'
          : 'Seleccionar para descargar PDF'" />
              {{ cedula.nombre }} {{ cedula.apellidoPaterno }} {{ cedula.apellidoMaterno }}
            </td>

            <!-- Status -->
            <td style="text-align:center">
              <ng-container *ngIf="cedula.__sending; else estadoIcono">
                <span class="mini-spinner"></span>
              </ng-container>
              <ng-template #estadoIcono>
                <img *ngIf="cedula.__okSent || cedula.ok || isCorregido((currentPage-1)*itemsPerPage + i)"
                  src="assets/images/file_approva_ico.png" class="ok img-fluid" />
                <img *ngIf="!(cedula.__okSent || cedula.ok || isCorregido((currentPage-1)*itemsPerPage + i))"
                  src="assets/images/file_rejected_ico.png" class="nook img-fluid" />
              </ng-template>
            </td>

            <!-- Descripción -->
            <td style="text-align:center">
              <ng-container *ngIf="cedula.__sending">Enviando…</ng-container>
              <ng-container *ngIf="cedula.__okSent"><span class="text-success fw-bold">ENVIADO</span></ng-container>
              <ng-container *ngIf="!cedula.__sending && !cedula.__okSent">
                <ng-container *ngIf="cedula.editado || !(cedula.descripcionerror?.trim()); else errores">
                  <span class="text-success fw-bold">LISTO PARA DESCARGAR</span>
                </ng-container>
                <ng-template #errores>
                  {{ cedula.__errorMsg || cedula.descripcionerror }}
                </ng-template>
              </ng-container>
            </td>

            <!-- Acción -->
            <td style="text-align:center">
              <img *ngIf="!cedula.__sending && (cedula.ok || isCorregido((currentPage-1)*itemsPerPage + i))"
                src="assets/images/file_download_pdf_ico.png" class="upload" [class.disabled]="cedula.__okSent"
                (click)="!cedula.__okSent && downloadPDF(cedula)" />
              <img *ngIf="!cedula.__sending && !cedula.ok && !isCorregido((currentPage-1)*itemsPerPage + i)"
                src="assets/images/file_edit_ico.png" class="warning"
                (click)="irIndividual(cedula, (currentPage-1)*itemsPerPage + i)" />
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginación -->
      <div class="solicitudes_masiva-paginacion">
        <button class="solicitudes_masiva-pagina-btn" (click)="cambiarPagina(currentPage - 1)"
          [disabled]="currentPage === 1">«</button>
        <button *ngFor="let p of pages" class="solicitudes_masiva-pagina-btn" [class.active]="p === currentPage"
          (click)="cambiarPagina(p)">{{ p }}</button>
        <button class="solicitudes_masiva-pagina-btn" (click)="cambiarPagina(currentPage + 1)"
          [disabled]="currentPage === totalPages">»</button>
      </div>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="botones-final">
    <div class="fila fila-1">
      <input type="file" id="fileInput" (change)="handleFileSelection($event)" hidden />
      <button class="btn-grande" type="button" (click)="openFilePicker()">
        {{ selectedFile?.name || 'SELECCIONAR ARCHIVO' }}
      </button>
    </div>
    <div class="fila fila-2">
      <button class="btn-chico" type="button" (click)="descargarPDFsMasivos()" [disabled]="!(allPreviewData.length)">
        DESCARGAR
      </button>
      <button class="btn-chico" type="button" (click)="sendSolicitudMasiva()"
        [disabled]="sending || !haySeleccionValida">
        <span *ngIf="sending" class="mini-spinner inline"></span>
        CARGAR
      </button>
    </div>
  </div>

  <!-- Overlay de loader general durante envío -->
  <div class="loaderlogin-overlay" *ngIf="overlayLoaderVisible">
    <div class="loaderlogin-spinner"></div>
    <p>Enviando…</p>
  </div>

  <!-- Barra de progreso masivo -->
  <div class="carmasiv-overlay" *ngIf="carmasivMostrandoLoader">
    <div class="carmasiv-loader-box">
      <div class="carmasiv-barra-contenedor">
        <div class="carmasiv-barra-progreso" [style.width.%]="carmasivProgreso"></div>
      </div>
      <p>{{ carmasivProgreso }}%</p>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div *ngIf="showToast" class="toast-container" [class.toast-show]="!isHiding" [class.toast-hide]="isHiding"
    [style.backgroundColor]="toastColor">
    {{ toastMessage }}
  </div>
</ng-container>