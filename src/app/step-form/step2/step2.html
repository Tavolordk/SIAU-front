<div class="container-fluid px-0">
  <!-- Título y progreso -->
  <div class="header-title">Registro</div>
  <div class="progress-bar-bg">
    <div class="progress-bar-fill" [style.width.%]="(currentStep/maxSteps)*100"></div>
  </div>
  <p class="progress-step">Paso {{ currentStep }} de {{ maxSteps }}</p>

  <div class="main-container mt-4">
    <div class="section-header">SELECCIÓN DE PERFIL</div>
    <div class="divider"></div>

    <div class="section-content">
      <!-- FORM -->
      <form [formGroup]="form" (ngSubmit)="agregarPerfil()">
        <div class="form-inline mb-0">
          <label for="perfilInput" class="form-label">*Perfil:</label>

          <ng-select [items]="perfilesDisponibles" bindLabel="funcion" bindValue="id" [searchable]="true"
            [clearable]="false" [dropdownPosition]="'auto'" [appendTo]="'body'" [hideSelected]="true"
            class="form-control" formControlName="perfil"
            (change)="onNgSelectChange($event)">
            <ng-template ng-option-tmp let-item="item">
              {{ item.clave }} - {{ item.funcion }}
            </ng-template>
          </ng-select>

          <button type="button" class="btn btn-quitar" (click)="onQuitarClick($event)"
            [disabled]="perfilesAgregados.length === 0">
            Quitar
          </button>

          <button type="button" class="btn btn-agregar" (click)="agregarPerfil()" [disabled]="!canAgregar">
            Agregar
          </button>

        </div>
      </form>

      <!-- LISTA -->
      <div class="perfil-list mt-3">
        @for (perfil of perfilesAgregados; track $index) {
        <div class="perfil-item">
          <span class="perfil-id">{{ perfil.clave }}</span>
          <span class="perfil-remove" (click)="eliminarPerfil($index)">
            <i class="fas fa-times"></i>
          </span>
          <span class="perfil-desc">{{ perfil.funcion }}</span>
        </div>
        }
        @empty {
        <div class="text-muted">No hay perfiles agregados.</div>
        }
      </div>

      <!-- ⚠️ error de validación (al menos 1 perfil) -->
      <div class="validation-message" *ngIf="hasError('perfiles','minLengthArray')">
        Debes agregar al menos un perfil.
      </div>
    </div>

    <div class="divider mt-4"></div>

    <!-- Botones de pie -->
    <div class="footer-actions">
      <button class="btn btn-regresar" (click)="prev.emit()">Regresar</button>
      <button class="btn btn-siguiente" (click)="tryProceed()" [disabled]="triedSubmit && perfilesFA.invalid">
        Siguiente
      </button> <!-- opcional: deshabilitar cuando ya intentó y sigue inválido -->
      <!-- [disabled]="triedSubmit && form.invalid" -->
    </div>
  </div>
</div>