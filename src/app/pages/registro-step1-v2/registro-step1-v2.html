<app-header-siau [title]="'Sistema Integral de Administración de Usuarios'" [userName]="usuarioNombre"
    [userRole]="usuarioRol" [logoSrc]="'../../../assets/images/SSPC.png'"
    [bgSrc]="'../../../assets/images/encabezado.png'" [height]="120" [showUser]="true">
</app-header-siau>

<!-- Título y avance -->
<app-registro-progress [title]="'Registro'" [currentStep]="currentStep" [totalSteps]="totalSteps ?? maxSteps"
    [percent]="progressPercent" [accent]="'#7a1832'">
</app-registro-progress>

<p class="section-title text-center">Registro de datos de usuario</p>

<!-- Contenedor principal del formulario -->
<div class="form-container mt-2">
    <div class="form-section-inner">
        <p class="form-note mb-2">*</p>

        <!-- Tipo de usuario (usa catálogo: tipoDeUsuario) -->
        <div class="tipo-usuario-container mb-4" [formGroup]="form">
            <label for="tipoUsuario" class="form-label required">Tipo de usuario</label>
            <select id="tipoUsuario" class="form-select" formControlName="tipoUsuario" required>
                <option [ngValue]="null" disabled>Seleccione un tipo</option>
                <option *ngFor="let t of tipoDeUsuario" [ngValue]="t.id">{{ t.nombre }}</option>
            </select>
        </div>

        <h2 class="form-section mb-0">Información personal</h2>
        <p class="form-note mt-2 mb-2">*Campos requeridos</p>

        <!-- Formulario principal -->
        <form [formGroup]="form" (ngSubmit)="tryProceed($event)">
            <!-- Honeypot (debe quedar vacío) -->
            <input type="text" formControlName="hp" tabindex="-1" aria-hidden="true"
                style="position:absolute; left:-9999px;" />

            <!-- ¿Personal de Seguridad Pública? -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required">¿Eres personal de Seguridad Pública?</label><br>
                    <div class="form-check form-check-inline">
                        <input id="seguridadSi" class="form-check-input" type="radio" value="Si"
                            formControlName="esSeguridad">
                        <label class="form-check-label" for="seguridadSi">Sí</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input id="seguridadNo" class="form-check-input" type="radio" value="No"
                            formControlName="esSeguridad">
                        <label class="form-check-label" for="seguridadNo">No</label>
                    </div>
                </div>
            </div>

            <!-- CURP + CAPTCHA -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="curp">CURP</label>
                    <input id="curp" class="form-control" type="text" maxlength="18" formControlName="curp">
                    <div><a class="captcha-link" href="https://www.gob.mx/curp/" target="_blank">¿No sabes tu CURP?</a>
                    </div>
                </div>
            </div>

            <!-- CAPTCHA real (sustituye imagen estática e input 'captchaText') -->
            <div class="form-row mb-2 align-items-end">
                <div class="form-group-captcha">
                    <label class="form-label" for="captcha">Código</label>

                    <!-- El componente emite (changed) y (refreshed) en tu versión vieja -->
                    <app-captcha-box (changed)="onCaptchaChange($event)"></app-captcha-box>

                    <!-- Feedback opcional del captcha (basado en 'captchaCode') -->
                    <div *ngIf="form.get('captchaCode')?.pending" class="text-info mt-2">Verificando…</div>
                    <div *ngIf="form.get('captchaCode')?.touched && form.get('captchaCode')?.errors as e"
                        class="text-danger mt-2">
                        <div *ngIf="e['required']">El código es obligatorio.</div>
                        <div *ngIf="e['pattern']">El código debe tener 6 dígitos.</div>
                        <div *ngIf="e['captchaInvalid']">Código incorrecto o expirado.</div>
                        <div *ngIf="e['captchaError']">No se pudo verificar el código. Intenta de nuevo.</div>
                    </div>
                </div>
            </div>

            <div class="form-row mb-2">
                <button type="button" class="verify-btn" (click)="onVerifyCurp()">Verificar CURP</button>
            </div>

            <!-- Nombres -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="nombre">Nombre (s)</label>
                    <input id="nombre" class="form-control" type="text" formControlName="nombre">
                </div>
                <div class="form-group">
                    <label class="form-label required" for="primerApellido">Primer apellido</label>
                    <input id="primerApellido" class="form-control" type="text" formControlName="primerApellido">
                </div>
                <div class="form-group">
                    <label class="form-label" for="segundoApellido">Segundo apellido</label>
                    <input id="segundoApellido" class="form-control" type="text" formControlName="segundoApellido">
                </div>
            </div>

            <!-- Sexo / Fecha -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="sexo">Sexo</label>
                    <select id="sexo" class="form-select" formControlName="sexo">
                        <option [ngValue]="null" disabled>Seleccionar</option>
                        <option *ngFor="let s of sexos" [ngValue]="s.id">{{ s.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="fechaNacimiento">Fecha de nacimiento</label>
                    <div class="input-group">
                        <input id="fechaNacimiento" class="form-control" type="date" formControlName="fechaNacimiento"
                            [attr.min]="'1900-01-01'" [attr.max]="todayISO">
                        <span class="input-group-text" style="background:#ededed; border:none;">
                            <fa-icon [icon]="icCalendar"></fa-icon>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Nacionalidad / País de nacimiento -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="nacionalidad">Nacionalidad</label>
                    <select id="nacionalidad" class="form-select" formControlName="nacionalidad">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let n of nacionalidades" [ngValue]="n.id">{{ n.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="paisNacimiento">País de nacimiento</label>
                    <select id="paisNacimiento" class="form-select" formControlName="paisNacimiento">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let p of paises" [ngValue]="p.id">{{ p.nombre }}</option>
                    </select>
                </div>
            </div>

            <!-- Entidad / Municipio nacimiento -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="entidadNacimiento">Entidad de nacimiento</label>
                    <select id="entidadNacimiento" class="form-select" formControlName="entidadNacimiento">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let e of entidades" [ngValue]="e.id">{{ e.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="municipioAlcaldia">Municipio/Alcaldía</label>
                    <select id="municipioAlcaldia" class="form-select" formControlName="municipioAlcaldia">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let m of municipiosNacimiento" [ngValue]="m.id">{{ m.nombre }}</option>
                    </select>
                </div>
            </div>

            <!-- Estado civil / RFC / CUIP -->
            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label" for="estadoCivil">Estado Civil</label>
                    <select id="estadoCivil" class="form-select" formControlName="estadoCivil">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let ec of estadosCiviles" [ngValue]="ec.id">{{ ec.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="rfc">RFC</label>
                    <input id="rfc" class="form-control" type="text" maxlength="13" formControlName="rfc">
                </div>
                <div class="form-group">
                    <label class="form-label" for="cuip">CUIP</label>
                    <input id="cuip" class="form-control" type="text" formControlName="cuip">
                </div>
            </div>

            <!-- Adscripción actual -->
            <h3 class="form-section-gold mt-4 mb-0">Información de adscripción actual</h3>
            <div class="form-row mb-2 mt-3">
                <div class="form-group">
                    <label class="form-label required" for="tipoInstitucion">Tipo de institución</label>
                    <select id="tipoInstitucion" class="form-select" formControlName="tipoInstitucion">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let a of ambitos" [ngValue]="a.id">{{ a.nombre }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="entidad">Entidad</label>
                    <select id="entidad" class="form-select" formControlName="entidad">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let e of entidades" [ngValue]="e.id">{{ e.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="municipioAlcaldia2">Municipio/Alcaldía</label>
                    <select id="municipioAlcaldia2" class="form-select" formControlName="municipioAlcaldia2">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let m of municipiosAdscripcion" [ngValue]="m.id">{{ m.nombre }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="institucion">Institución</label>
                    <select id="institucion" class="form-select" formControlName="institucion">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let i of instituciones" [ngValue]="i.id">{{ i.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dependencia">Dependencia</label>
                    <select id="dependencia" class="form-select" formControlName="dependencia">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let d of dependencias" [ngValue]="d.id">{{ d.nombre }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label" for="corporacion">Corporación</label>
                    <select id="corporacion" class="form-select" formControlName="corporacion">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let c of corporaciones" [ngValue]="c.id">{{ c.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="area">Área</label>
                    <select id="area" class="form-select" formControlName="area">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let a of areas" [ngValue]="a.id">{{ a.nombre }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row mb-2">
                <div class="form-group">
                    <label class="form-label required" for="fechaIngreso">Fecha de ingreso</label>
                    <input id="fechaIngreso" class="form-control" type="date" formControlName="fechaIngreso"
                        [attr.min]="minFechaIngreso" [attr.max]="todayISO">
                </div>
                <div class="form-group">
                    <label class="form-label required" for="numeroEmpleado">Número de empleado</label>
                    <input id="numeroEmpleado" class="form-control" type="text" formControlName="numeroEmpleado">
                </div>
            </div>

            <!-- Comisión -->
            <h3 class="form-section-gold mt-4 mb-0">En caso de estar comisionado</h3>
            <div class="form-row mb-2 mt-3">
                <div class="form-group">
                    <label class="form-label required">¿Está comisionado?</label><br>
                    <div class="form-check form-check-inline">
                        <input id="comisionadoSi" class="form-check-input" type="radio" value="Si"
                            formControlName="comisionado">
                        <label for="comisionadoSi" class="form-check-label">Sí</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input id="comisionadoNo" class="form-check-input" type="radio" value="No"
                            formControlName="comisionado">
                        <label for="comisionadoNo" class="form-check-label">No</label>
                    </div>
                </div>
            </div>

            <div class="form-row mb-2" [class.section-disabled]="form.get('comisionado')?.value !== 'Si'">
                <div class="form-group">
                    <label class="form-label required" for="tipoInstitucion2">Tipo de institución</label>
                    <select id="tipoInstitucion2" class="form-select" formControlName="tipoInstitucion2">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let a of ambitos" [ngValue]="a.id">{{ a.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="entidad2">Entidad</label>
                    <select id="entidad2" class="form-select" formControlName="entidad2">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let e of entidades" [ngValue]="e.id">{{ e.nombre }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row mb-2" [class.section-disabled]="form.get('comisionado')?.value !== 'Si'">
                <div class="form-group">
                    <label class="form-label required" for="municipioAlcaldia3">Municipio</label>
                    <select id="municipioAlcaldia3" class="form-select" formControlName="municipioAlcaldia3">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let m of municipiosComision" [ngValue]="m.id">{{ m.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="institucion2">Institución</label>
                    <select id="institucion2" class="form-select" formControlName="institucion2">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let i of instituciones2" [ngValue]="i.id">{{ i.nombre }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row mb-2" [class.section-disabled]="form.get('comisionado')?.value !== 'Si'">
                <div class="form-group">
                    <label class="form-label" for="dependencia2">Dependencia</label>
                    <select id="dependencia2" class="form-select" formControlName="dependencia2">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let d of dependencias2" [ngValue]="d.id">{{ d.nombre }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="corporacion2">Corporación</label>
                    <select id="corporacion2" class="form-select" formControlName="corporacion2">
                        <option [ngValue]="null" disabled>Selecciona</option>
                        <option *ngFor="let c of corporaciones2" [ngValue]="c.id">{{ c.nombre }}</option>
                    </select>
                </div>
            </div>

            <!-- Términos -->
            <div class="form-row mb-2 mt-3">
                <div class="form-check">
                    <input id="aceptaTerminos" class="form-check-input" type="checkbox"
                        formControlName="aceptaTerminos">
                    <label for="aceptaTerminos" class="form-check-label terms-label">
                        Acepta los <a class="terms-link" href="#">términos y condiciones</a> de uso del Sistema Integral
                        de Administración de Usuarios.
                    </label>
                </div>
            </div>

            <!-- Acciones -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary-custom" (click)="prev.emit()">
                    <fa-icon [icon]="icLeft"></fa-icon>
                    Regresar
                </button>

                <button type="submit" class="btn btn-custom">
                    Siguiente
                    <fa-icon [icon]="icRight"></fa-icon>
                </button>
            </div>
        </form>
    </div>
</div>