<app-header-siau
  [title]="'Sistema Integral de Administración de Usuarios'"
  [userName]="usuarioNombre"
  [userRole]="usuarioRol"
  [logoSrc]="'../../../assets/images/SSPC.png'"
  [bgSrc]="'../../../assets/images/encabezado.png'"
  [height]="120"
  [showUser]="true">
</app-header-siau>

<div class="main-content">
  <div class="container">
    <app-registro-progress
      [title]="'Registro'"
      [currentStep]="currentStep"
      [totalSteps]="totalSteps"
      [percent]="progressPercent"
      [accent]="'#7a1832'">
    </app-registro-progress>

    <div class="selection-header">Selección de perfil</div>

    <form [formGroup]="form" (ngSubmit)="agregarPerfil()">
      <div class="mb-3 d-flex gap-2 align-items-center">

        <!-- ng-select con búsqueda por clave/función -->
        <ng-select class="profile-input flex-grow-1"
                   [items]="perfilesDisponibles"
                   bindLabel="funcion"
                   bindValue="id"
                   [searchable]="true"
                   [searchFn]="searchPerfil"
                   [clearable]="false"
                   [dropdownPosition]="'auto'"
                   [appendTo]="'body'"
                   [hideSelected]="true"
                   placeholder="Selecciona un perfil"
                   formControlName="perfil"
                   (change)="onNgSelectChange($event)">

          <ng-template ng-option-tmp let-item="item">
            {{ item.clave }} - {{ item.funcion }}
          </ng-template>
        </ng-select>

        <button class="add-btn btn" type="submit" [disabled]="!canAgregar">
          Agregar
          <fa-icon [icon]="icPlus" class="ms-1" [fixedWidth]="true"></fa-icon>
        </button>

        <button type="button" class="btn btn-quitar" (click)="onQuitarClick($event)" [disabled]="!perfilesAgregados.length">
          Quitar
        </button>
      </div>
    </form>

    <!-- Lista de perfiles agregados -->
    <div class="profile-list">
      <div class="profile-item" *ngFor="let p of perfilesAgregados; let i = index">
        <span class="perfil-id">{{ p.clave }}</span>
        <span class="perfil-desc">{{ p.funcion }}</span>
        <fa-icon [icon]="icTrash" class="trash-icon" (click)="eliminarPerfil(i)" role="button" aria-label="Eliminar"></fa-icon>
      </div>
      <div class="text-muted" *ngIf="!perfilesAgregados.length">No hay perfiles agregados.</div>
    </div>

    <!-- error de validación (al menos 1 perfil) -->
    <div class="validation-message" *ngIf="perfilesFA.invalid && triedSubmit">
      Debes agregar al menos un perfil.
    </div>

    <!-- Footer acciones -->
    <div class="row mt-4">
      <div class="col-6">
        <button class="btn-back" type="button" (click)="prev.emit()">
          <fa-icon [icon]="icLeft"></fa-icon>
          <span class="ms-1">Regresar</span>
        </button>
      </div>
      <div class="col-6 text-end">
        <button class="btn-next" type="button" (click)="tryProceed($event)">
          <span class="me-1">Siguiente</span>
          <fa-icon [icon]="icRight"></fa-icon>
        </button>
      </div>
    </div>
  </div>
</div>
