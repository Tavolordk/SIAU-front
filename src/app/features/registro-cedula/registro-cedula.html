<div class="container-xl py-3 px-2">

  <!-- CTA: Nueva solicitud -->
  <app-hero-cta
    label="Nueva solicitud"
    color="vino"
    size="lg"
    (clicked)="onCancelar()">
  </app-hero-cta>

  <!-- Selección de requerimientos: usa datos del detalle -->
  <app-seleccion-requerimientos
    [usuarioId]="detalle?.cuenta_codigo ?? ''"
    [folio]="detalle?.folio ?? ''"
    [fecha]="detalle?.fecha_pantalla ?? ''"
    [hora]="detalle?.hora_pantalla ?? ''"
    [selected]="tipoSeleccionado"
    (cambio)="$event"
    (cerrar)="onCerrarModal()"
    [disableNuevaCuenta]="true">
  </app-seleccion-requerimientos>

  <!-- Estado -->
  <div class="alert alert-info my-2" *ngIf="loadingConsulta">Cargando cédula…</div>
  <div class="alert alert-danger my-2" *ngIf="apiError">{{ apiError }}</div>
  <div class="small text-muted my-1" *ngIf="detalle">
    Folio: <b>{{ detalle.folio }}</b> · Estado: <b>{{ detalle.estado_solicitud }}</b>
  </div>

  <!-- Título -->
  <div class="barra-titulo my-3">Cédula única de registro de usuarios</div>

  <!-- ===== Información personal ===== -->
  <div class="panel mb-4">
    <div class="panel-header vino">Información personal</div>
    <div class="panel-body" [formGroup]="fPersonal">

      <!-- ¿Personal de Seguridad Pública? -->
      <div class="row align-items-center mb-3">
        <div class="col-12 text-center fw-bold mb-2">
          ¿Eres personal de Seguridad Pública? <span class="req">*</span>
        </div>
        <div class="col-12 d-flex justify-content-center gap-4">
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="spSi" [value]="true" formControlName="esPersonalSP" [disabled]="loadingConsulta">
            <label class="form-check-label" for="spSi">Sí</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="spNo" [value]="false" formControlName="esPersonalSP" [disabled]="loadingConsulta">
            <label class="form-check-label" for="spNo">No</label>
          </div>
        </div>
      </div>

      <!-- Usuario / CURP -->
      <div class="row g-3 align-items-end">
        <div class="col-md-12 text-center mb-1">
          <label class="form-label">Usuario</label>
          <input class="form-control bg-secondary-subtle" formControlName="usuario" name="usuario" [disabled]="loadingConsulta" placeholder="Usuario">
        </div>

        <div class="col-md-12 text-center">
          <label class="form-label">CURP <span class="req">*</span></label>
          <input class="form-control bg-secondary-subtle" formControlName="curp" [disabled]="loadingConsulta" placeholder="CURP">
        </div>

        <div class="col-md-6 d-flex gap-2">
          <button class="btn btn-secondary flex-fill" type="button" (click)="buscarCurp()" [disabled]="loadingConsulta">Buscar CURP</button>
        </div>
        <div class="col-md-6 d-flex gap-2">
          <button class="btn btn-oro flex-fill text-white" type="button" (click)="validarCurp()" [disabled]="loadingConsulta">Validar CURP</button>
        </div>
      </div>

      <!-- Nombres -->
      <div class="row g-3 mt-1">
        <div class="col-md-4 text-center">
          <label class="form-label">Nombre(s) <span class="req">*</span></label>
          <input class="form-control bg-secondary-subtle" formControlName="nombre" [disabled]="loadingConsulta">
        </div>
        <div class="col-md-4 text-center">
          <label class="form-label">Primer apellido <span class="req">*</span></label>
          <input class="form-control bg-secondary-subtle" formControlName="primerApellido" [disabled]="loadingConsulta">
        </div>
        <div class="col-md-4 text-center">
          <label class="form-label">Segundo apellido</label>
          <input class="form-control bg-secondary-subtle" formControlName="segundoApellido" [disabled]="loadingConsulta">
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-12">
          <label class="form-label">Sexo <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="sexo" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of sexos" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>

        <div class="col-md-12">
          <label class="form-label">Fecha de nacimiento <span class="req">*</span></label>
          <input type="date" class="form-control bg-secondary-subtle" formControlName="fechaNacimiento" [disabled]="loadingConsulta">
        </div>

        <div class="col-md-12">
          <label class="form-label">Nacionalidad <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="nacionalidad" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of nacionalidades" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-12">
          <label class="form-label">País de nacimiento <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="paisNacimiento" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of paises" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Entidad de nacimiento <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="entidadNacimiento" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of entidades" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Municipio/Alcaldía <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="municipioNacimiento" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of municipios" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-12">
          <label class="form-label">Estado civil</label>
          <select class="form-select bg-secondary-subtle" formControlName="estadoCivil" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of estadosCiviles" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-12">
          <label class="form-label">RFC</label>
          <input class="form-control bg-secondary-subtle" formControlName="rfc" [disabled]="loadingConsulta">
        </div>
        <div class="col-md-12">
          <label class="form-label">CUIP</label>
          <input class="form-control bg-secondary-subtle" formControlName="cuip" [disabled]="loadingConsulta">
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Correo electrónico <span class="req">*</span></label>
          <input class="form-control bg-secondary-subtle" formControlName="correo" type="email" [disabled]="loadingConsulta">
        </div>
        <div class="col-md-6">
          <label class="form-label">Número de celular <span class="req">*</span></label>
          <input class="form-control bg-secondary-subtle" formControlName="celular" [disabled]="loadingConsulta">
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-12 justify-content-center d-flex align-items-center">
          <label class="form-label me-3 mb-0">Cuenta con aplicativo de Telegram:</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input input-radio-red" type="radio" id="tgSi" [value]="true" formControlName="aplicativo" [disabled]="loadingConsulta">
            <label class="form-check-label" for="tgSi">Sí</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input input-radio-red" type="radio" id="tgNo" [value]="false" formControlName="aplicativo" [disabled]="loadingConsulta">
            <label class="form-check-label" for="tgNo">No</label>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ===== Adscripción actual ===== -->
  <div class="panel mb-4">
    <div class="panel-header oro">Información de adscripción actual</div>
    <div class="panel-body" [formGroup]="fAds">
      <div class="row g-3">
        <div class="col-md-12 text-center">
          <label class="form-label">Tipo de institución <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="tipoInstitucion" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of tiposInstitucion" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6 text-center">
          <label class="form-label">Entidad <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="entidad" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of entidades" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6 text-center">
          <label class="form-label">Municipio/Alcaldía <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="municipio" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of municipios" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>

        <div class="col-md-6 text-center">
          <label class="form-label">Institución <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="institucion" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of instituciones" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6 text-center">
          <label class="form-label">Dependencia <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="dependencia" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of dependencias" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6 text-center">
          <label class="form-label">Corporación <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="corporacion" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of corporaciones" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>

        <div class="col-md-6 text-center">
          <label class="form-label">Área <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="area" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of areas" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6 text-center">
          <label class="form-label">Cargo</label>
          <input class="form-control bg-secondary-subtle" formControlName="cargo" [disabled]="loadingConsulta">
        </div>
        <div class="col-md-6 text-center">
          <label class="form-label">Funciones</label>
          <input class="form-control bg-secondary-subtle" formControlName="funciones" [disabled]="loadingConsulta" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Fecha de ingreso <span class="req">*</span></label>
          <input type="date" class="form-control bg-secondary-subtle" formControlName="fechaIngreso" [disabled]="loadingConsulta">
        </div>
        <div class="col-md-6">
          <label class="form-label">Número de empleado</label>
          <input class="form-control bg-secondary-subtle" formControlName="numeroEmpleado" [disabled]="loadingConsulta">
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Comisionado ===== -->
  <div class="panel mb-4">
    <div class="panel-header oro">En caso de estar comisionado</div>
    <div class="panel-body" [formGroup]="fComision">

      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label me-3">¿Está comisionado? <span class="req">*</span></label>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="comSi" [value]="true" formControlName="estaComisionado" (change)="onCambioComisionado(true)" [disabled]="loadingConsulta">
            <label class="form-check-label" for="comSi">Sí</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="comNo" [value]="false" formControlName="estaComisionado" (change)="onCambioComisionado(false)" [disabled]="loadingConsulta">
            <label class="form-check-label" for="comNo">No</label>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">País <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="pais" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of paises" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo de institución <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="tipoInstitucion" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of tiposInstitucion" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Entidad <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="entidad" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of entidades" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Municipio <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="municipio" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of municipios" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Institución <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="institucion" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of instituciones" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Dependencia <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="dependencia" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of dependencias" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Corporación <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="corporacion" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let o of corporaciones" [ngValue]="o.value">{{ o.label }}</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Especificar</label>
          <input class="form-control bg-secondary-subtle" formControlName="especificar" placeholder="Detalle" [disabled]="loadingConsulta">
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Perfiles de usuario ===== -->
  <div class="panel mb-4">
    <div class="panel-header oro">Perfiles de usuario</div>
    <div class="panel-body">
      <div class="row g-2 align-items-end" [formGroup]="form">
        <div class="col-md-9">
          <label class="form-label">Agregar perfil de consulta</label>
          <select class="form-select bg-secondary-subtle" formControlName="perfilSeleccionado" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let p of perfilesConsulta" [ngValue]="p.value">{{ p.label }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="button" class="btn btn-oro w-100 text-white" (click)="agregarPerfilSeleccionado()" [disabled]="loadingConsulta">
            Agregar +
          </button>
        </div>
      </div>

      <ul class="list-group mt-3" *ngIf="perfilesFA.length > 0">
        <li class="list-group-item d-flex justify-content-between align-items-center"
            *ngFor="let p of perfilesFA.controls; let i = index">
          <span>{{ labelPerfil(p.value) }}</span>
          <button class="btn btn-sm btn-outline-danger" type="button" (click)="eliminarPerfil(i)" [disabled]="loadingConsulta">
            Quitar
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- ===== Documentos ===== -->
  <div class="panel mb-4">
    <div class="panel-header oro">Documentos</div>
    <div class="panel-body">

      <!-- Selección tipo -->
      <div class="row g-3 align-items-end doc-controls" [formGroup]="form">
        <div class="col-lg-12 col-md-12">
          <label class="form-label">Tipo de documento <span class="req">*</span></label>
          <select class="form-select bg-secondary-subtle" formControlName="tipoDocumentoActual" [disabled]="loadingConsulta">
            <option [ngValue]="null">Selecciona</option>
            <option *ngFor="let t of tiposDocumento" [ngValue]="t.value">{{ t.label }}</option>
          </select>
        </div>
      </div>

      <!-- Archivo + Subir -->
      <div class="row g-3 align-items-end doc-controls">
        <div class="col-lg-5 col-md-6">
          <label class="form-label d-block">Archivo</label>
          <div class="input-file">
            <input id="docFile" type="file" class="visually-hidden" (change)="onArchivoSeleccionado($event)" [disabled]="loadingConsulta">
            <label for="docFile" class="btn btn-oro text-white">Elegir archivo</label>
            <span class="ms-2 text-muted small">PDF / PNG &nbsp;|&nbsp; máx. 2&nbsp;MB</span>
          </div>
        </div>

        <div class="col-lg-3 col-md-4">
          <label class="form-label d-block invisible">Subir</label>
          <button type="button" class="btn btn-oro w-100 text-white" [disabled]="loadingConsulta">
            Subir
          </button>
        </div>
      </div>

      <!-- Lista dinámica -->
      <div class="table-responsive mt-3" *ngIf="documentosFA.length > 0">
        <table class="table table-bordered align-middle table-sm">
          <thead>
            <tr>
              <th style="width:40%">Tipo</th>
              <th>Nombre de archivo</th>
              <th style="width:130px" class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let doc of documentosFA.controls; let i = index" [formGroup]="doc">
              <td>{{ labelDocumento(doc.get('tipo')?.value) }}</td>
              <td>{{ doc.get('nombreArchivo')?.value }}</td>
              <td class="text-center">
                <fa-icon [icon]="icons.eye" class="me-2 btn" (click)="verDocumento(i)"></fa-icon>
                <fa-icon [icon]="icons.trash" class="btn" (click)="eliminarDocumento(i)"></fa-icon>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Nota -->
      <div class="row mt-2">
        <div class="col-12">
          <div class="text-center">
            <b>Se requiere cargar: INE, recibo de nómina (quincena inmediata anterior) y credencial laboral.</b><br />
          </div>
          <span>El total de los archivos no puede superar los 10MB. Archivos permitidos: PDF o JPG.</span>
        </div>
      </div>

      <!-- Botonera -->
      <div class="d-flex flex-wrap gap-2 mt-3">
        <button class="btn btn-secondary" type="button" (click)="onGuardar()" [disabled]="loadingConsulta || loadingEstado">
          <fa-icon [icon]="icons.save" class="me-2"></fa-icon> Guardar
        </button>
        <button class="btn btn-oro text-white" type="button" (click)="onValidar()" [disabled]="loadingConsulta || loadingEstado">
          {{ loadingEstado ? 'Procesando…' : 'Validar' }}
        </button>
        <button class="btn btn-danger" type="button" (click)="onRechazar()" [disabled]="loadingConsulta || loadingEstado">
          {{ loadingEstado ? 'Procesando…' : 'Rechazar' }}
        </button>
        <button class="btn btn-danger ms-auto" type="button" (click)="onCancelar()">Cancelar</button>
      </div>
    </div>
  </div>

</div>
